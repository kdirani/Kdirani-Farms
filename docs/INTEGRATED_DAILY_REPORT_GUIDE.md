# دليل استخدام التقرير اليومي المتكامل

## 🎯 نظرة سريعة

تم تطوير نظام متكامل لإنشاء التقرير اليومي يتضمن إنشاء الفواتير تلقائياً في نفس الوقت.

---

## 📍 الصفحة

**الرابط:** `http://localhost:3000/farmer/daily-report`

**الوصول:** متاح للمزارعين فقط (farmer role)

---

## 🔄 آلية العمل

### 1. البيض السليم ✅
- **يُضاف** إلى المخزون كمادة "بيض"
- يُحفظ في حقل `purchases` في جدول `materials`
- يزيد `current_balance`

### 2. البيض المشوه ❌
- **لا يدخل المخزون أبداً**
- يُستخدم فقط في الحسابات (إجمالي الإنتاج، نسبة الإنتاج)

### 3. البيض المباع 💰
- يُنشئ فاتورة مبيع تلقائياً
- يُحفظ في حقل `sales` في جدول `materials`
- ينقص `current_balance`

### 4. البيض الهدايا 🎁
- يُحفظ في حقل `consumption` في جدول `materials`
- ينقص `current_balance`
- **لا يُنشئ فاتورة**

### 5. السواد 💩
- يُنشئ مادة "سواد" تلقائياً عند أول مبيع
- فاتورة مبيع السواد تنقص من `sales`

### 6. الأدوية 💊
- فاتورة استهلاك الأدوية تنقص من `consumption`
- يتم عرض الأدوية المتاحة في المخزون فقط
- يتم عرض الكمية المتاحة بجانب كل دواء

---

## 📊 الحسابات التلقائية

| الحقل | الحساب |
|------|--------|
| **إجمالي الإنتاج** | بيض صحي + بيض مشوه |
| **نسبة الإنتاج** | (إجمالي الإنتاج ÷ عدد الدجاج قبل) × 100 |
| **الرصيد الحالي** | الرصيد السابق + بيض صحي - بيض مباع - بيض هدايا |
| **العدد بعد** | العدد قبل - النافق |

---

## 🆕 التقرير الأول

عند إنشاء **أول تقرير** للمستودع:
- ✅ يتم جلب **عدد الدجاج** تلقائياً من جدول `poultry_status`
- ✅ يتم إنشاء مادة **"بيض"** تلقائياً في المستودع

---

## 📦 الفواتير (اختيارية)

### 1. فاتورة مبيع البيض 🥚

**الحقول المطلوبة:**
- وزن البيض (من قائمة الأوزان)
- الوحدة (من قائمة الوحدات)
- الكمية
- السعر

**الحقول الاختيارية:**
- الزبون

**الميزات:**
- إمكانية إضافة عدة بنود (أوزان مختلفة)
- حساب المبلغ تلقائياً = الكمية × السعر

---

### 2. فاتورة مبيع السواد 💩

**الحقول المطلوبة:**
- الوحدة (من قائمة الوحدات)
- الكمية
- السعر

**الحقول الاختيارية:**
- الزبون

**ملاحظة:** يتم إنشاء مادة "سواد" تلقائياً عند أول مبيع

---

### 3. فاتورة استهلاك الأدوية 💊

**الحقول المطلوبة:**
- الدواء (من قائمة الأدوية المتاحة في المخزون)
- الوحدة
- الكمية
- السعر

**الحقول الاختيارية:**
- القطيع

**الميزات الخاصة:**
- ✅ عرض الكمية المتاحة بجانب كل دواء
- ✅ منع إضافة كمية أكبر من المتاح
- ✅ حساب الكمية المتاحة مع الأخذ بعين الاعتبار البيانات غير المحفوظة
- ✅ إمكانية إضافة عدة أدوية في نفس الفاتورة

**مثال:**
```
الدواء: مضاد حيوي (متاح: 50)
الوحدة: كيلو جرام
الكمية: 10
السعر: 100
المبلغ: 1000 (محسوب تلقائياً)
```

---

## 📎 المرفقات

- إمكانية رفع حتى **5 ملفات**
- الحجم الأقصى لكل ملف: **10 ميجابايت**
- الأنواع المدعومة: صور، PDF، مستندات

---

## ⚠️ ملاحظات مهمة

### 1. الوحدات الافتراضية
يجب التأكد من وجود هذه الوحدات في جدول `measurement_units`:
- **كرتونة** (للبيض)
- **كيلو جرام** (للسواد والأدوية)

### 2. الزبائن
- يتم عرض الزبائن من نوع **"customer"** فقط
- يجب إضافة الزبائن من صفحة إدارة الزبائن أولاً

### 3. الأدوية
- يتم عرض الأدوية التي لها رصيد في المخزون فقط
- الأدوية يجب أن تكون مضافة عبر فواتير شراء أولاً

### 4. القطيع
- يجب إضافة معلومات القطيع من صفحة إدارة القطعان
- القطيع مطلوب فقط عند إضافة فاتورة استهلاك أدوية

---

## 🔍 مثال عملي

### سيناريو: تقرير يومي كامل

```
📅 التاريخ: 2025-10-05
⏰ الوقت: 08:00

🥚 إنتاج البيض:
- بيض صحي: 1000 كرتونة
- بيض مشوه: 50 كرتونة
- إجمالي الإنتاج: 1050 كرتونة (محسوب تلقائياً)
- الرصيد السابق: 200 كرتونة
- البيض المباع: 800 كرتونة
- بيض هدايا: 50 كرتونة
- الرصيد الحالي: 350 كرتونة (محسوب تلقائياً)

🐔 حالة القطيع:
- العدد قبل: 10000
- النافق: 20
- العدد بعد: 9980 (محسوب تلقائياً)
- نسبة الإنتاج: 10.50% (محسوبة تلقائياً)

🌾 العلف والسواد:
- العلف اليومي: 500 كجم
- العلف الشهري: 15000 كجم
- معدل التحويل: 2.5
- إنتاج السواد: 100 كجم

📦 فاتورة مبيع البيض:
- الزبون: محمد أحمد
- وزن البيض: 1850/1800
- الوحدة: كرتونة
- الكمية: 800
- السعر: 50 ريال
- المبلغ: 40000 ريال

💩 فاتورة مبيع السواد:
- الزبون: علي محمود
- الوحدة: كيلو جرام
- الكمية: 100
- السعر: 5 ريال
- المبلغ: 500 ريال

💊 فاتورة استهلاك الأدوية:
- القطيع: قطيع 2025-A
- الدواء: مضاد حيوي (متاح: 50)
- الوحدة: كيلو جرام
- الكمية: 10
- السعر: 100 ريال
- المبلغ: 1000 ريال
```

**النتيجة:**
- ✅ تم إنشاء التقرير اليومي
- ✅ تم إنشاء فاتورة مبيع بيض برقم: `EGG-SALE-1728097200000`
- ✅ تم إنشاء فاتورة مبيع سواد برقم: `DROP-SALE-1728097200001`
- ✅ تم إنشاء فاتورة استهلاك أدوية برقم: `MED-CONS-1728097200002`
- ✅ تم تحديث المخزون بشكل صحيح

---

## 🐛 استكشاف الأخطاء

### المشكلة: "وحدة القياس الافتراضية غير موجودة"
**الحل:** تأكد من وجود وحدة "كرتونة" في جدول `measurement_units`

### المشكلة: "لا تظهر الأدوية في القائمة"
**الحل:** 
1. تأكد من إضافة الأدوية في جدول `medicines`
2. تأكد من شراء الأدوية عبر فواتير شراء
3. تحقق من أن الرصيد الحالي > 0

### المشكلة: "الكمية المتاحة: 0"
**الحل:** قم بشراء الدواء عبر فاتورة شراء أولاً

### المشكلة: "لا يظهر الزبائن"
**الحل:** أضف زبائن من نوع "customer" من صفحة إدارة الزبائن

---

## 📞 الدعم الفني

للمزيد من المساعدة، راجع:
- 📄 [التوثيق الكامل](./edits/integrated_daily_report_implementation.md)
- 📊 [السكيما](./schema.md)
- 🗂️ [ملفات الأكشن](../actions/integrated-daily-report.actions.ts)

---

**آخر تحديث:** 2025-10-05  
**الإصدار:** 1.0
