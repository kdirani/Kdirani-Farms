# توثيق صفحة التقرير العام

## 📋 نظرة عامة

تم إنشاء صفحة **التقرير العام** لعرض تقارير شاملة عن جميع الأنشطة والإنتاج في المزارع، مع إمكانية الفلترة والتصدير إلى Excel.

**المسار:** `/admin/reports/general`

---

## 🎯 الميزات الرئيسية

### 1. **البطاقات الملخصة (Summary Cards)**
عرض 6 بطاقات تحتوي على:
- ✅ إجمالي البيض المُنتَج
- ✅ إجمالي البيض المباع
- ✅ إجمالي الأعلاف المستهلكة (كغم)
- ✅ إجمالي السواد المباع (كغم)
- ✅ إجمالي الطيور النافقة
- ✅ متوسط الإنتاج اليومي

### 2. **الفلاتر المتقدمة**
- **المزرعة**: فلترة حسب مزرعة محددة أو جميع المزارع
- **الفترة الزمنية**:
  - اليوم الحالي
  - آخر 7 أيام
  - آخر 30 يومًا
  - فترة مخصصة (من - إلى)
- **التواريخ المخصصة**: اختيار تواريخ بداية ونهاية محددة

### 3. **التقارير المجمعة**

#### 📅 **التقارير اليومية**
- عرض جميع التقارير اليومية في الفترة المحددة
- الحقول المعروضة:
  - التاريخ
  - المزرعة
  - المستودع
  - البيض المُنتَج
  - البيض المباع
  - الأعلاف المستهلكة
  - السواد المباع
  - عدد الطيور النافقة

#### 📊 **التقارير الأسبوعية**
- تجميع البيانات على أساس أسبوعي
- عرض رقم الأسبوع والفترة (من - إلى)
- حساب المجاميع الأسبوعية
- حساب متوسط الإنتاج اليومي لكل أسبوع
- **مقارنة مع الأسبوع السابق**:
  - نسبة الزيادة/النقصان (%)
  - مؤشرات بصرية (↑ ↓ ➡️)

#### 📈 **التقارير الشهرية**
- تجميع البيانات على أساس شهري
- عرض الشهر والسنة
- حساب المجاميع الشهرية
- حساب متوسط الإنتاج اليومي لكل شهر
- **مقارنة مع الشهر السابق**:
  - نسبة الزيادة/النقصان (%)
  - مؤشرات بصرية (↑ ↓ ➡️)

### 4. **تصدير Excel**
- تصدير جميع البيانات إلى ملف Excel
- يحتوي على 4 أوراق عمل:
  1. **الملخص**: الإحصائيات العامة + الفلاتر المطبقة
  2. **التقارير اليومية**: كل التقارير التفصيلية
  3. **التقارير الأسبوعية**: الملخصات الأسبوعية
  4. **التقارير الشهرية**: الملخصات الشهرية

---

## 📁 هيكل الملفات

```
📦 التقرير العام
├── 📄 app/(dashboard)/admin/reports/general/page.tsx
│   └── Server Component - جلب البيانات الأولية
│
├── 📄 actions/general-report.actions.ts
│   ├── getDailyReports()        - جلب التقارير اليومية
│   ├── getWeeklySummary()       - حساب الملخص الأسبوعي
│   ├── getMonthlySummary()      - حساب الملخص الشهري
│   └── getOverallStatistics()   - حساب الإحصائيات الشاملة
│
└── 📂 components/admin/reports/
    ├── 📄 general-report-view.tsx       - المكون الرئيسي
    ├── 📄 report-filters.tsx            - مكون الفلاتر
    ├── 📄 summary-cards.tsx             - البطاقات الملخصة
    ├── 📄 daily-reports-table.tsx       - جدول التقارير اليومية
    ├── 📄 weekly-summary-table.tsx      - جدول التقارير الأسبوعية
    ├── 📄 monthly-summary-table.tsx     - جدول التقارير الشهرية
    └── 📄 export-report-button.tsx      - زر تصدير Excel
```

---

## 🔧 التفاصيل التقنية

### **Server Actions**

#### 1. `getDailyReports(filters)`
```typescript
// جلب التقارير اليومية من قاعدة البيانات
// يستخدم جدول daily_reports
// يجلب البيانات من warehouse -> farm
```

**الحقول المستخدمة:**
- `production_eggs` - عدد البيض المنتج
- `eggs_sold` - عدد البيض المباع
- `feed_daily_kg` - كمية الأعلاف اليومية
- `production_droppings` - كمية السواد المنتج
- `chicks_dead` - عدد الطيور النافقة

**الفلترة:**
- إذا تم اختيار مزرعة: يجلب جميع المستودعات التابعة لها
- يطبق فلاتر التاريخ (من - إلى)

#### 2. `getWeeklySummary(filters)`
```typescript
// يجمع التقارير اليومية حسب الأسبوع
// يحسب المجاميع والمتوسطات
// يحسب النسبة المئوية للمقارنة مع الأسبوع السابق
```

#### 3. `getMonthlySummary(filters)`
```typescript
// يجمع التقارير اليومية حسب الشهر
// يحسب المجاميع والمتوسطات
// يحسب النسبة المئوية للمقارنة مع الشهر السابق
```

#### 4. `getOverallStatistics(filters)`
```typescript
// يحسب الإحصائيات الإجمالية لجميع الفترة
// يستخدم في البطاقات الملخصة
```

---

### **المكونات (Components)**

#### 1. `general-report-view.tsx`
**الوظيفة:** المكون الرئيسي الذي يدير الحالة والتنسيق

**State:**
```typescript
const [dailyReports, setDailyReports] = useState(...)
const [weeklySummary, setWeeklySummary] = useState(...)
const [monthlySummary, setMonthlySummary] = useState(...)
const [stats, setStats] = useState(...)
const [isLoading, setIsLoading] = useState(false)
```

**الوظائف:**
- `handleFilterChange()` - عند تطبيق الفلاتر، يجلب البيانات الجديدة

#### 2. `report-filters.tsx`
**الوظيفة:** مكون الفلاتر

**State:**
```typescript
const [farms, setFarms] = useState([])
const [selectedFarm, setSelectedFarm] = useState('all')
const [period, setPeriod] = useState('month')
const [startDate, setStartDate] = useState('')
const [endDate, setEndDate] = useState('')
```

**الوظائف:**
- `loadFarms()` - جلب قائمة المزارع
- `handlePeriodChange()` - تحديث التواريخ حسب الفترة المختارة
- `handleApplyFilters()` - تطبيق الفلاتر وإرسالها للمكون الأب
- `handleReset()` - إعادة تعيين الفلاتر للوضع الافتراضي

#### 3. `summary-cards.tsx`
**الوظيفة:** عرض البطاقات الملخصة

**Props:**
```typescript
interface SummaryCardsProps {
  stats: {
    total_eggs_produced: number;
    total_eggs_sold: number;
    total_feed_consumed: number;
    total_droppings_sold: number;
    total_mortality: number;
    average_daily_production: number;
    total_reports: number;
  };
}
```

#### 4. `daily-reports-table.tsx`
**الوظيفة:** عرض جدول التقارير اليومية

**Props:**
```typescript
interface DailyReportsTableProps {
  reports: DailyReportSummary[];
}
```

#### 5. `weekly-summary-table.tsx`
**الوظيفة:** عرض جدول التقارير الأسبوعية مع المقارنات

**الميزات:**
- حساب النسبة المئوية للتغيير
- عرض مؤشرات بصرية (Badges)
- ترتيب الأسابيع من الأحدث للأقدم

#### 6. `monthly-summary-table.tsx`
**الوظيفة:** عرض جدول التقارير الشهرية مع المقارنات

**الميزات:**
- حساب النسبة المئوية للتغيير
- عرض مؤشرات بصرية (Badges)
- ترتيب الأشهر من الأحدث للأقدم

#### 7. `export-report-button.tsx`
**الوظيفة:** تصدير البيانات إلى Excel

**المكتبات المستخدمة:**
- `xlsx` - إنشاء ملفات Excel
- `file-saver` - حفظ الملف

---

## 🗄️ قاعدة البيانات

### **الجدول المستخدم: `daily_reports`**

**الحقول الرئيسية:**
```sql
- id                        (uuid)
- warehouse_id              (uuid) - العلاقة مع المستودع
- report_date               (date)
- production_eggs           (integer) - عدد البيض المنتج
- eggs_sold                 (integer) - عدد البيض المباع
- feed_daily_kg             (numeric) - الأعلاف اليومية
- production_droppings      (numeric) - إنتاج السواد
- chicks_dead               (integer) - عدد الطيور النافقة
- notes                     (text)
```

**العلاقات:**
```
daily_reports
  └── warehouse_id → warehouses
                        └── farm_id → farms
```

---

## 🎨 الواجهة

### **التخطيط (Layout)**

```
┌─────────────────────────────────────────────────────┐
│  التقرير العام                                      │
│  تقرير شامل لجميع الأنشطة والإنتاج في المزارع      │
├─────────────────────────────────────────────────────┤
│  [الفلاتر]                                          │
│  المزرعة | الفترة | من تاريخ | إلى تاريخ           │
│  [تطبيق الفلاتر] [إعادة تعيين]                     │
├─────────────────────────────────────────────────────┤
│  [6 بطاقات ملخصة]                                  │
├─────────────────────────────────────────────────────┤
│  [زر تصدير Excel]                                   │
├─────────────────────────────────────────────────────┤
│  [Tabs]                                             │
│  - التقارير اليومية                                │
│  - التقارير الأسبوعية                              │
│  - التقارير الشهرية                                │
│                                                     │
│  [جدول البيانات]                                   │
└─────────────────────────────────────────────────────┘
```

### **الألوان والأيقونات**

**البطاقات الملخصة:**
- 🔵 البيض المُنتَج - أزرق
- 🟢 البيض المباع - أخضر
- 🟡 الأعلاف - أصفر/عنبر
- 🟠 السواد - برتقالي
- 🔴 النفوق - أحمر
- 🟣 المتوسط اليومي - بنفسجي

**مؤشرات المقارنة:**
- ↑ زيادة - أخضر (success)
- ↓ نقصان - أحمر (destructive)
- ➡️ ثابت - رمادي (secondary)

---

## 🔄 سير العمل (Workflow)

### **عند فتح الصفحة:**
1. يتم جلب البيانات الأولية (آخر 30 يوم)
2. عرض البطاقات الملخصة
3. عرض التقارير في Tabs

### **عند تطبيق الفلاتر:**
1. المستخدم يختار الفلاتر
2. ينقر على "تطبيق الفلاتر"
3. يتم عرض Loading state
4. استدعاء Server Actions مع الفلاتر
5. تحديث جميع المكونات بالبيانات الجديدة

### **عند التصدير:**
1. المستخدم ينقر على "تصدير Excel"
2. يتم إنشاء ملف Excel مع 4 أوراق
3. يتم تنزيل الملف تلقائياً

---

## 📊 أمثلة على الاستخدام

### **عرض تقارير مزرعة محددة:**
1. اختر المزرعة من القائمة المنسدلة
2. اختر الفترة (مثلاً: آخر 30 يومًا)
3. انقر على "تطبيق الفلاتر"

### **عرض تقارير فترة مخصصة:**
1. اختر "فترة مخصصة" من قائمة الفترة
2. حدد تاريخ البداية
3. حدد تاريخ النهاية
4. انقر على "تطبيق الفلاتر"

### **تصدير البيانات:**
1. طبق الفلاتر المطلوبة
2. انقر على زر "تصدير Excel"
3. سيتم تنزيل ملف باسم: `تقرير-عام-YYYY-MM-DD.xlsx`

---

## 🔍 استكشاف الأخطاء

### **لا تظهر أي بيانات:**

**السبب المحتمل:**
- لا توجد تقارير يومية في الفترة المحددة
- المزرعة المختارة ليس لها مستودعات
- لا توجد تقارير يومية تم إدخالها

**الحل:**
1. افتح Console في المتصفح (F12)
2. ابحث عن رسائل console.log التي تعرض البيانات
3. تحقق من وجود تقارير في `/admin/daily-reports`
4. تحقق من تواريخ التقارير

### **الفلاتر لا تعمل:**

**الحل:**
1. تأكد من اختيار تواريخ صحيحة
2. تأكد من وجود بيانات في الفترة المحددة
3. جرب "إعادة تعيين" الفلاتر

---

## 🚀 التحسينات المستقبلية المقترحة

1. **رسوم بيانية:**
   - إضافة مخططات خطية للاتجاهات
   - مخططات دائرية للتوزيع

2. **تنبيهات ذكية:**
   - تنبيه عند انخفاض الإنتاج عن المعدل
   - تنبيه عند ارتفاع معدل النفوق

3. **تحليلات متقدمة:**
   - حساب معدل تحويل العلف (FCR)
   - مقارنة الأداء بين المزارع

4. **جدولة التقارير:**
   - إرسال تقارير أسبوعية/شهرية بالبريد الإلكتروني

5. **تصدير PDF:**
   - إضافة إمكانية التصدير كـ PDF مع تنسيق احترافي

---

## 👥 الصلاحيات

**يمكن الوصول إلى هذه الصفحة من قبل:**
- ✅ Admin (المدير)
- ❌ Farmer (المزارع)

**المسار في القائمة الجانبية:**
```
التقارير → التقرير العام
```

---

## 📝 ملاحظات مهمة

1. **البيانات الأولية:** عند فتح الصفحة لأول مرة، يتم عرض بيانات آخر 30 يوم

2. **المستودعات:** كل مزرعة لها مستودع واحد، لذلك لا داعي لفلتر منفصل للمستودع

3. **الأداء:** استخدام `useTransition` من Next.js 15 لتحسين تجربة المستخدم

4. **التحديث التلقائي:** استخدام `revalidatePath` في Server Actions للتحديث التلقائي

---

## 🔗 الروابط ذات الصلة

- **الصفحة:** `/admin/reports/general`
- **الكود:** `app/(dashboard)/admin/reports/general/`
- **Server Actions:** `actions/general-report.actions.ts`
- **المكونات:** `components/admin/reports/`

---

## 📅 تاريخ الإنشاء

**التاريخ:** 2025-10-07  
**النسخة:** 1.0.0  
**المطور:** Cascade AI  
**الحالة:** ✅ مكتمل وجاهز للاستخدام

---

## ✅ قائمة التحقق (Checklist)

- [x] إنشاء Server Actions
- [x] إنشاء الصفحة الرئيسية
- [x] إنشاء مكون الفلاتر
- [x] إنشاء البطاقات الملخصة
- [x] إنشاء جداول التقارير (يومية، أسبوعية، شهرية)
- [x] إضافة المقارنات بين الفترات
- [x] إضافة وظيفة التصدير Excel
- [x] إضافة الرابط في القائمة الجانبية
- [x] اختبار الصفحة
- [x] كتابة التوثيق

---

## 📞 الدعم

في حالة وجود أي مشاكل أو استفسارات، يرجى:
1. التحقق من Console للرسائل
2. مراجعة هذا التوثيق
3. التواصل مع فريق التطوير
