# تعليمات إنشاء Pull Request

## 🔗 الرابط المباشر

افتح هذا الرابط في المتصفح:

```
https://github.com/elnaanah/al-qadeerani-poultry-farm/compare/main...cursor/fix-manufacturing-invoice-logical-issues-c33f
```

---

## 📝 العنوان (Title)

```
إصلاح المشاكل المنطقية في نظام فاتورة التصنيع وإضافة تحسينات
```

---

## 📄 الوصف (Description)

انسخ والصق النص التالي في حقل الوصف:

```markdown
## 📋 الملخص

تم حل **جميع المشاكل المنطقية الستة** في نظام إنشاء فاتورة التصنيع بالإضافة إلى **3 ميزات إضافية**.

---

## ✅ المشاكل المحلولة (6/6)

### 1️⃣ إضافة validation للمواد المدخلة
- ✓ لا يمكن إنشاء فاتورة بدون مواد مدخلة
- ✓ رسالة خطأ واضحة للمستخدم

### 2️⃣ نقل منطق زيادة المادة الناتجة
- ✓ دالة جديدة: `addOutputMaterialToInventory()`
- ✓ يتم إضافة المادة الناتجة فقط بعد نجاح جميع المواد المدخلة
- ✓ منع حالات عدم تناسق المخزون

### 3️⃣ التحقق من توفر المواد قبل الإنشاء
- ✓ دالة جديدة: `validateInputMaterialsStock()`
- ✓ رسائل تفصيلية بالمواد الناقصة والكميات المتوفرة/المطلوبة
- ✓ منع إنشاء فواتير بمواد غير متوفرة

### 4️⃣ آلية Rollback للتراجع عن العمليات
- ✓ دالة جديدة: `rollbackManufacturingInvoice()`
- ✓ حذف تلقائي للفاتورة في حالة فشل إضافة المواد
- ✓ ضمان تناسق البيانات

### 5️⃣ استبدال window.location.reload()
- ✓ الاعتماد على `revalidatePath` من server actions
- ✓ تجربة مستخدم أفضل

### 6️⃣ جعل الحقول إجبارية
- ✓ المادة الناتجة: إجبارية
- ✓ الوحدة: إجبارية
- ✓ الكمية: يجب أن تكون > 0

---

## ✨ الميزات الإضافية (3)

### 7️⃣ عرض المخزون المتوفر
- ✓ يظهر المخزون تلقائياً عند اختيار المادة المدخلة
- ✓ 🟢 باللون الأخضر إذا متوفر | 🔴 باللون الأحمر إذا فارغ
- ✓ منع إدخال كميات أكبر من المتوفر
- ✓ رسالة خطأ تفصيلية بالكمية المتوفرة والمطلوبة

### 8️⃣ المادة الناتجة إجبارية
- ✓ تم إزالة خيار "لا توجد مادة"
- ✓ يجب اختيار مادة ناتجة لإنشاء الفاتورة

### 9️⃣ تصفية الأعلاف فقط
- ✓ عرض المواد التي تبدأ بـ "علف" فقط
- ✓ مثال: علف دجاج، علف بياض، علف تسمين

---

## 🎯 الترتيب الجديد للعمليات

```
1. التحقق من وجود مواد مدخلة
2. التحقق من توفر جميع المواد في المخزون
3. إنشاء الفاتورة
4. إضافة المواد المدخلة (↓ تقليل المخزون)
5. إضافة المادة الناتجة (↑ زيادة المخزون)
6. إضافة المصاريف
7. رفع المرفقات

⚠️ في حالة الفشل: rollback تلقائي
```

---

## 📊 إحصائيات التغييرات

- **الملفات المعدلة**: 4 ملفات
- **الأسطر المضافة/المعدلة**: 482 سطر
- **الدوال الجديدة**: 3 دوال
- **الميزات المطبقة**: 9 ميزات

### الملفات المعدلة:
1. `components/admin/manufacturing/create-manufacturing-dialog.tsx`
2. `actions/manufacturing.actions.ts`
3. `actions/manufacturing-item.actions.ts`
4. `docs/MANUFACTURING_FIXES.md` (توثيق جديد)

---

## 📋 الحقول الإجبارية الآن

- ✓ رقم الفاتورة
- ✓ تاريخ التصنيع
- ✓ المستودع
- ✓ المادة الناتجة (أعلاف فقط)
- ✓ الوحدة
- ✓ الكمية (> 0)
- ✓ مواد مدخلة (1+)

---

## ✅ الفوائد الرئيسية

- ✅ سلامة البيانات وتناسق المخزون
- ✅ تجربة مستخدم محسنة مع رسائل واضحة
- ✅ استرجاع تلقائي في حالة الفشل
- ✅ منع الأخطاء قبل حدوثها
- ✅ شفافية كاملة في العمليات
- ✅ مرونة أكبر مع حماية أفضل

---

## 📝 التوثيق

التوثيق الكامل متوفر في: `docs/MANUFACTURING_FIXES.md`

---

## ⚠️ ملاحظة

تأكد من وجود مواد بأسماء تبدأ بـ "علف" في قاعدة البيانات قبل الاستخدام.
```

---

## 📌 معلومات إضافية

- **Branch**: `cursor/fix-manufacturing-invoice-logical-issues-c33f`
- **Base**: `main`
- **Commits**: 4
- **Files**: 4
- **Lines**: +482

---

## ✅ الخطوات

1. افتح الرابط المذكور أعلاه
2. اضغط على "Create pull request"
3. انسخ العنوان والصقه
4. انسخ الوصف والصقه
5. اضغط "Create pull request"
