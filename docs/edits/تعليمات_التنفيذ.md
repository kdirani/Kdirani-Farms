# تعليمات تنفيذ تكامل الأدوية مع الفواتير

## 🔴 المشكلة
عند محاولة تطبيق القيد `check_material_or_medicine`، حصلت على خطأ يفيد بأن هناك صفوف في الجدول لا تتوافق مع القيد.

## ✅ الحل

### الخطوة 1️⃣: إضافة الأعمدة فقط (بدون قيود)

افتح **Supabase SQL Editor** ونفذ:

```sql
BEGIN;

ALTER TABLE public.invoice_items 
ADD COLUMN IF NOT EXISTS medicine_id uuid REFERENCES public.medicines(id) ON DELETE SET NULL;

ALTER TABLE public.materials 
ADD COLUMN IF NOT EXISTS medicine_id uuid REFERENCES public.medicines(id) ON DELETE SET NULL;

COMMIT;
```

✅ **النتيجة المتوقعة**: `SUCCESS`

---

### الخطوة 2️⃣: فحص البيانات الموجودة

نفذ هذا الاستعلام:

```sql
SELECT 
  'invoice_items' as table_name,
  COUNT(*) as total_rows,
  COUNT(material_name_id) as has_material,
  COUNT(medicine_id) as has_medicine,
  SUM(CASE WHEN material_name_id IS NULL AND medicine_id IS NULL THEN 1 ELSE 0 END) as both_null,
  SUM(CASE WHEN material_name_id IS NOT NULL AND medicine_id IS NOT NULL THEN 1 ELSE 0 END) as both_not_null
FROM public.invoice_items;
```

📊 **افحص النتائج**:
- إذا كانت `both_null = 0` ← اذهب مباشرة للخطوة 4
- إذا كانت `both_null > 0` ← انتقل للخطوة 3

---

### الخطوة 3️⃣: إصلاح البيانات (إذا لزم الأمر)

#### الخيار أ: حذف الصفوف الفارغة

⚠️ **تحذير**: سيحذف جميع عناصر الفاتورة التي ليس لها مادة أو دواء

```sql
BEGIN;
DELETE FROM public.invoice_items 
WHERE material_name_id IS NULL AND medicine_id IS NULL;
COMMIT;
```

#### الخيار ب: تحديث الصفوف بقيمة افتراضية (الموصى به)

```sql
BEGIN;

-- إنشاء مادة افتراضية
INSERT INTO public.materials_names (material_name)
VALUES ('غير محدد')
ON CONFLICT (material_name) DO NOTHING;

-- تحديث invoice_items
UPDATE public.invoice_items 
SET material_name_id = (
  SELECT id FROM public.materials_names 
  WHERE material_name = 'غير محدد' 
  LIMIT 1
)
WHERE material_name_id IS NULL AND medicine_id IS NULL;

COMMIT;
```

✅ **النتيجة المتوقعة**: `UPDATE X` (حيث X عدد الصفوف المحدثة)

---

### الخطوة 4️⃣: إضافة القيود

الآن يمكننا إضافة القيود بأمان:

```sql
BEGIN;

-- إزالة القيود القديمة إن وجدت
ALTER TABLE public.invoice_items 
DROP CONSTRAINT IF EXISTS check_material_or_medicine;

ALTER TABLE public.materials 
DROP CONSTRAINT IF EXISTS check_material_or_medicine_in_stock;

-- إضافة القيود الجديدة
ALTER TABLE public.invoice_items
ADD CONSTRAINT check_material_or_medicine 
CHECK (
  (material_name_id IS NOT NULL AND medicine_id IS NULL) OR 
  (material_name_id IS NULL AND medicine_id IS NOT NULL)
);

ALTER TABLE public.materials
ADD CONSTRAINT check_material_or_medicine_in_stock
CHECK (
  (material_name_id IS NOT NULL AND medicine_id IS NULL) OR 
  (material_name_id IS NULL AND medicine_id IS NOT NULL)
);

COMMIT;
```

✅ **النتيجة المتوقعة**: `SUCCESS`

---

### الخطوة 5️⃣: تحديث الفهارس الفريدة

```sql
BEGIN;

-- إزالة القيد الفريد القديم من materials
ALTER TABLE public.materials 
DROP CONSTRAINT IF EXISTS unique_warehouse_material;

-- إنشاء فهارس فريدة منفصلة
DROP INDEX IF EXISTS unique_warehouse_material_name;
CREATE UNIQUE INDEX unique_warehouse_material_name 
ON public.materials (warehouse_id, material_name_id) 
WHERE material_name_id IS NOT NULL;

DROP INDEX IF EXISTS unique_warehouse_medicine;
CREATE UNIQUE INDEX unique_warehouse_medicine 
ON public.materials (warehouse_id, medicine_id) 
WHERE medicine_id IS NOT NULL;

COMMIT;
```

✅ **النتيجة المتوقعة**: `SUCCESS`

---

### الخطوة 6️⃣: التحقق النهائي

```sql
-- عرض القيود
SELECT 
  con.conname AS constraint_name,
  pg_get_constraintdef(con.oid) AS constraint_definition
FROM pg_constraint con
JOIN pg_class rel ON rel.oid = con.conrelid
WHERE rel.relname = 'invoice_items'
  AND con.conname = 'check_material_or_medicine';
```

✅ **النتيجة المتوقعة**: يجب أن تظهر القيود الجديدة

---

## 🎯 ملخص التغييرات

بعد تنفيذ جميع الخطوات بنجاح:

✅ تم إضافة عمود `medicine_id` إلى `invoice_items`
✅ تم إضافة عمود `medicine_id` إلى `materials`
✅ تم إضافة قيد يضمن وجود إما `material_name_id` أو `medicine_id` (وليس كلاهما أو لا شيء)
✅ تم تحديث الفهارس الفريدة لدعم كل من المواد والأدوية

---

## 🚀 الخطوات التالية

بعد تطبيق التغييرات على قاعدة البيانات، يجب عليك:

1. ✅ تحديث ملف `types/database.types.ts`
2. ✅ تحديث ملف `actions/invoice.actions.ts`
3. ✅ تحديث مكون `create-invoice-dialog.tsx`
4. ✅ اختبار إضافة فاتورة مع أدوية

سأساعدك في تنفيذ هذه الخطوات بعد التأكد من نجاح تحديث قاعدة البيانات.

---

## ❓ حل المشاكل

### المشكلة: "check constraint is violated"
**الحل**: ارجع للخطوة 2 وافحص البيانات، ثم نفذ الخطوة 3

### المشكلة: "relation does not exist"
**الحل**: تأكد من أنك متصل بقاعدة البيانات الصحيحة

### المشكلة: "permission denied"
**الحل**: تأكد من أنك مسجل دخول كمسؤول في Supabase

---

## 📞 تواصل معي

إذا واجهت أي مشكلة في أي خطوة، أخبرني بالرسالة الخطأ بالضبط وسأساعدك في حلها.
