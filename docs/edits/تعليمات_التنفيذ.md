# ุชุนูููุงุช ุชูููุฐ ุชูุงูู ุงูุฃุฏููุฉ ูุน ุงูููุงุชูุฑ

## ๐ด ุงููุดููุฉ
ุนูุฏ ูุญุงููุฉ ุชุทุจูู ุงูููุฏ `check_material_or_medicine`ุ ุญุตูุช ุนูู ุฎุทุฃ ูููุฏ ุจุฃู ููุงู ุตููู ูู ุงูุฌุฏูู ูุง ุชุชูุงูู ูุน ุงูููุฏ.

## โ ุงูุญู

### ุงูุฎุทูุฉ 1๏ธโฃ: ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ููุท (ุจุฏูู ูููุฏ)

ุงูุชุญ **Supabase SQL Editor** ูููุฐ:

```sql
BEGIN;

ALTER TABLE public.invoice_items 
ADD COLUMN IF NOT EXISTS medicine_id uuid REFERENCES public.medicines(id) ON DELETE SET NULL;

ALTER TABLE public.materials 
ADD COLUMN IF NOT EXISTS medicine_id uuid REFERENCES public.medicines(id) ON DELETE SET NULL;

COMMIT;
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: `SUCCESS`

---

### ุงูุฎุทูุฉ 2๏ธโฃ: ูุญุต ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ

ููุฐ ูุฐุง ุงูุงุณุชุนูุงู:

```sql
SELECT 
  'invoice_items' as table_name,
  COUNT(*) as total_rows,
  COUNT(material_name_id) as has_material,
  COUNT(medicine_id) as has_medicine,
  SUM(CASE WHEN material_name_id IS NULL AND medicine_id IS NULL THEN 1 ELSE 0 END) as both_null,
  SUM(CASE WHEN material_name_id IS NOT NULL AND medicine_id IS NOT NULL THEN 1 ELSE 0 END) as both_not_null
FROM public.invoice_items;
```

๐ **ุงูุญุต ุงููุชุงุฆุฌ**:
- ุฅุฐุง ูุงูุช `both_null = 0` โ ุงุฐูุจ ูุจุงุดุฑุฉ ููุฎุทูุฉ 4
- ุฅุฐุง ูุงูุช `both_null > 0` โ ุงูุชูู ููุฎุทูุฉ 3

---

### ุงูุฎุทูุฉ 3๏ธโฃ: ุฅุตูุงุญ ุงูุจูุงูุงุช (ุฅุฐุง ูุฒู ุงูุฃูุฑ)

#### ุงูุฎูุงุฑ ุฃ: ุญุฐู ุงูุตููู ุงููุงุฑุบุฉ

โ๏ธ **ุชุญุฐูุฑ**: ุณูุญุฐู ุฌููุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุงูุชู ููุณ ููุง ูุงุฏุฉ ุฃู ุฏูุงุก

```sql
BEGIN;
DELETE FROM public.invoice_items 
WHERE material_name_id IS NULL AND medicine_id IS NULL;
COMMIT;
```

#### ุงูุฎูุงุฑ ุจ: ุชุญุฏูุซ ุงูุตููู ุจูููุฉ ุงูุชุฑุงุถูุฉ (ุงูููุตู ุจู)

```sql
BEGIN;

-- ุฅูุดุงุก ูุงุฏุฉ ุงูุชุฑุงุถูุฉ
INSERT INTO public.materials_names (material_name)
VALUES ('ุบูุฑ ูุญุฏุฏ')
ON CONFLICT (material_name) DO NOTHING;

-- ุชุญุฏูุซ invoice_items
UPDATE public.invoice_items 
SET material_name_id = (
  SELECT id FROM public.materials_names 
  WHERE material_name = 'ุบูุฑ ูุญุฏุฏ' 
  LIMIT 1
)
WHERE material_name_id IS NULL AND medicine_id IS NULL;

COMMIT;
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: `UPDATE X` (ุญูุซ X ุนุฏุฏ ุงูุตููู ุงููุญุฏุซุฉ)

---

### ุงูุฎุทูุฉ 4๏ธโฃ: ุฅุถุงูุฉ ุงููููุฏ

ุงูุขู ูููููุง ุฅุถุงูุฉ ุงููููุฏ ุจุฃูุงู:

```sql
BEGIN;

-- ุฅุฒุงูุฉ ุงููููุฏ ุงููุฏููุฉ ุฅู ูุฌุฏุช
ALTER TABLE public.invoice_items 
DROP CONSTRAINT IF EXISTS check_material_or_medicine;

ALTER TABLE public.materials 
DROP CONSTRAINT IF EXISTS check_material_or_medicine_in_stock;

-- ุฅุถุงูุฉ ุงููููุฏ ุงูุฌุฏูุฏุฉ
ALTER TABLE public.invoice_items
ADD CONSTRAINT check_material_or_medicine 
CHECK (
  (material_name_id IS NOT NULL AND medicine_id IS NULL) OR 
  (material_name_id IS NULL AND medicine_id IS NOT NULL)
);

ALTER TABLE public.materials
ADD CONSTRAINT check_material_or_medicine_in_stock
CHECK (
  (material_name_id IS NOT NULL AND medicine_id IS NULL) OR 
  (material_name_id IS NULL AND medicine_id IS NOT NULL)
);

COMMIT;
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: `SUCCESS`

---

### ุงูุฎุทูุฉ 5๏ธโฃ: ุชุญุฏูุซ ุงูููุงุฑุณ ุงููุฑูุฏุฉ

```sql
BEGIN;

-- ุฅุฒุงูุฉ ุงูููุฏ ุงููุฑูุฏ ุงููุฏูู ูู materials
ALTER TABLE public.materials 
DROP CONSTRAINT IF EXISTS unique_warehouse_material;

-- ุฅูุดุงุก ููุงุฑุณ ูุฑูุฏุฉ ูููุตูุฉ
DROP INDEX IF EXISTS unique_warehouse_material_name;
CREATE UNIQUE INDEX unique_warehouse_material_name 
ON public.materials (warehouse_id, material_name_id) 
WHERE material_name_id IS NOT NULL;

DROP INDEX IF EXISTS unique_warehouse_medicine;
CREATE UNIQUE INDEX unique_warehouse_medicine 
ON public.materials (warehouse_id, medicine_id) 
WHERE medicine_id IS NOT NULL;

COMMIT;
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: `SUCCESS`

---

### ุงูุฎุทูุฉ 6๏ธโฃ: ุงูุชุญูู ุงูููุงุฆู

```sql
-- ุนุฑุถ ุงููููุฏ
SELECT 
  con.conname AS constraint_name,
  pg_get_constraintdef(con.oid) AS constraint_definition
FROM pg_constraint con
JOIN pg_class rel ON rel.oid = con.conrelid
WHERE rel.relname = 'invoice_items'
  AND con.conname = 'check_material_or_medicine';
```

โ **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: ูุฌุจ ุฃู ุชุธูุฑ ุงููููุฏ ุงูุฌุฏูุฏุฉ

---

## ๐ฏ ููุฎุต ุงูุชุบููุฑุงุช

ุจุนุฏ ุชูููุฐ ุฌููุน ุงูุฎุทูุงุช ุจูุฌุงุญ:

โ ุชู ุฅุถุงูุฉ ุนููุฏ `medicine_id` ุฅูู `invoice_items`
โ ุชู ุฅุถุงูุฉ ุนููุฏ `medicine_id` ุฅูู `materials`
โ ุชู ุฅุถุงูุฉ ููุฏ ูุถูู ูุฌูุฏ ุฅูุง `material_name_id` ุฃู `medicine_id` (ูููุณ ููุงููุง ุฃู ูุง ุดูุก)
โ ุชู ุชุญุฏูุซ ุงูููุงุฑุณ ุงููุฑูุฏุฉ ูุฏุนู ูู ูู ุงูููุงุฏ ูุงูุฃุฏููุฉ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุชุทุจูู ุงูุชุบููุฑุงุช ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุฌุจ ุนููู:

1. โ ุชุญุฏูุซ ููู `types/database.types.ts`
2. โ ุชุญุฏูุซ ููู `actions/invoice.actions.ts`
3. โ ุชุญุฏูุซ ูููู `create-invoice-dialog.tsx`
4. โ ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ูุงุชูุฑุฉ ูุน ุฃุฏููุฉ

ุณุฃุณุงุนุฏู ูู ุชูููุฐ ูุฐู ุงูุฎุทูุงุช ุจุนุฏ ุงูุชุฃูุฏ ูู ูุฌุงุญ ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช.

---

## โ ุญู ุงููุดุงูู

### ุงููุดููุฉ: "check constraint is violated"
**ุงูุญู**: ุงุฑุฌุน ููุฎุทูุฉ 2 ูุงูุญุต ุงูุจูุงูุงุชุ ุซู ููุฐ ุงูุฎุทูุฉ 3

### ุงููุดููุฉ: "relation does not exist"
**ุงูุญู**: ุชุฃูุฏ ูู ุฃูู ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุตุญูุญุฉ

### ุงููุดููุฉ: "permission denied"
**ุงูุญู**: ุชุฃูุฏ ูู ุฃูู ูุณุฌู ุฏุฎูู ููุณุคูู ูู Supabase

---

## ๐ ุชูุงุตู ูุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ ูู ุฃู ุฎุทูุฉุ ุฃุฎุจุฑูู ุจุงูุฑุณุงูุฉ ุงูุฎุทุฃ ุจุงูุถุจุท ูุณุฃุณุงุนุฏู ูู ุญููุง.
