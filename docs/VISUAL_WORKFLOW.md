# سير العمل المرئي - نظام التنبيهات الدوائية 🎨

## 📊 رسم تخطيطي شامل

```
╔══════════════════════════════════════════════════════════════════════════╗
║                        نظام التنبيهات الدوائية                         ║
║                     من البداية إلى النهاية                             ║
╚══════════════════════════════════════════════════════════════════════════╝

┌────────────────────────────────────────────────────────────────────────┐
│  المرحلة 1: إعداد المزرعة والقطيع                                    │
└────────────────────────────────────────────────────────────────────────┘

    [المدير يدخل البيانات]
              ↓
    ┌─────────────────────┐
    │  إنشاء مستخدم       │  → auth.users
    │  (المزارع)          │  → public.profiles
    └─────────────────────┘
              ↓
    ┌─────────────────────┐
    │  إنشاء المزرعة      │  → public.farms
    └─────────────────────┘     (user_id, name, location)
              ↓
    ┌─────────────────────┐
    │  إنشاء المستودع     │  → public.warehouses
    └─────────────────────┘     (farm_id, name)
              ↓
    ┌─────────────────────┐
    │  إنشاء القطيع       │  → public.poultry_status
    └─────────────────────┘     (farm_id, batch_name, opening_chicks)
              ↓
              ⚠️
    [chick_birth_date = NULL]
    ❌ لا توجد تنبيهات بعد!


┌────────────────────────────────────────────────────────────────────────┐
│  المرحلة 2: إضافة تاريخ ميلاد الفراخ                                 │
└────────────────────────────────────────────────────────────────────────┘

    [المزارع/المدير يضيف التاريخ]
              ↓
    ╔═════════════════════════════╗
    ║  UPDATE poultry_status      ║
    ║  SET chick_birth_date =     ║
    ║      '2025-10-10'           ║
    ║  WHERE id = 'uuid'          ║
    ╚═════════════════════════════╝
              ↓
              ⚡ TRIGGER!
              ↓
    trg_auto_create_medication_alerts
              ↓
    auto_create_medication_alerts()
              ↓
    [استدعاء الدالة الرئيسية]


┌────────────────────────────────────────────────────────────────────────┐
│  المرحلة 3: إنشاء التنبيهات تلقائياً                                 │
└────────────────────────────────────────────────────────────────────────┘

    create_medication_alerts_for_poultry()
              │
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  الخطوة 1: جلب جميع الأدوية                            │
    └─────────────────────────────────────────────────────────┘
              │
              ↓
    SELECT * FROM medicines WHERE day_of_age IS NOT NULL
              │
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  الدواء 1: "مضاد حيوي" → أيام: "1+2+3"                 │
    │  الدواء 2: "برايمر"     → أيام: "4"                    │
    │  الدواء 3: "كلون"       → أيام: "6"                    │
    │  الدواء 4: "جامبورو"    → أيام: "10"                   │
    │  ...                                                     │
    └─────────────────────────────────────────────────────────┘
              │
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  الخطوة 2: لكل دواء → تحليل الأيام                     │
    └─────────────────────────────────────────────────────────┘
              │
              ↓
    "مضاد حيوي" → "1+2+3"
              │
              ↓ parse_medicine_days()
              │
              ↓
        [1, 2, 3] ← مصفوفة
              │
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  الخطوة 3: لكل يوم → حساب التواريخ                     │
    └─────────────────────────────────────────────────────────┘
              │
    ┌─────────┼────────────────────────────────────────┐
    │         │                                        │
    ↓         ↓                                        ↓
  اليوم 1   اليوم 2                               اليوم 3
    │         │                                        │
    ↓         ↓                                        ↓
┌───────┐ ┌───────┐                              ┌───────┐
│scheduled│ │scheduled│                            │scheduled│
│ _date  │ │ _date  │                            │ _date  │
│        │ │        │                            │        │
│2025-   │ │2025-   │                            │2025-   │
│10-11   │ │10-12   │                            │10-13   │
└───────┘ └───────┘                              └───────┘
    │         │                                        │
    ↓         ↓                                        ↓
┌───────┐ ┌───────┐                              ┌───────┐
│ alert  │ │ alert  │                            │ alert  │
│ _date  │ │ _date  │                            │ _date  │
│        │ │        │                            │        │
│2025-   │ │2025-   │                            │2025-   │
│10-10   │ │10-11   │                            │10-12   │
└───────┘ └───────┘                              └───────┘
    │         │                                        │
    └─────────┴────────────────────────────────────────┘
                          │
                          ↓
    ┌─────────────────────────────────────────────────────────┐
    │  الخطوة 4: إدراج التنبيهات في قاعدة البيانات          │
    └─────────────────────────────────────────────────────────┘
                          │
                          ↓
              INSERT INTO medication_alerts
                          │
              ┌───────────┼───────────┐
              │           │           │
              ↓           ↓           ↓
         تنبيه 1      تنبيه 2     تنبيه 3
    farm_id: uuid   farm_id: uuid   farm_id: uuid
    medicine: مضاد   medicine: مضاد   medicine: مضاد
    scheduled_day: 1 scheduled_day: 2 scheduled_day: 3
    scheduled_date:  scheduled_date:  scheduled_date:
      2025-10-11       2025-10-12       2025-10-13
    is_administered: is_administered: is_administered:
      FALSE            FALSE            FALSE
                          │
                          ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  ✅ تم إنشاء 40-50 تنبيه لجميع الأدوية             ║
    ╚═══════════════════════════════════════════════════════╝


┌────────────────────────────────────────────────────────────────────────┐
│  المرحلة 4: المزارع يدخل لوحة التحكم                                 │
└────────────────────────────────────────────────────────────────────────┘

    [المزارع يفتح farmer/page.tsx]
              ↓
    getUpcomingAlertsForUser(user_id, 10)
              ↓
    get_upcoming_alerts() في SQL
              │
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  SELECT ... FROM medication_alerts                       │
    │  WHERE farm.user_id = 'user-uuid'                       │
    │    AND NOT is_administered                              │
    │    AND scheduled_date >= CURRENT_DATE - 7               │
    │  ORDER BY urgency_level, scheduled_date                 │
    │  LIMIT 10                                               │
    └─────────────────────────────────────────────────────────┘
              ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  حساب الأولوية لكل تنبيه:                            ║
    ╚═══════════════════════════════════════════════════════╝
              │
    ┌─────────┼─────────────────────────────────────┐
    │         │                                     │
    ↓         ↓                                     ↓
scheduled_date  scheduled_date                scheduled_date
< TODAY         = TODAY                       = TODAY + 1
    │              │                                │
    ↓              ↓                                ↓
🚨 متأخر      ⚠️ اليوم                         📌 غداً
urgency: 1     urgency: 2                      urgency: 3
              │
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  النتيجة: قائمة مرتبة حسب الأولوية                     │
    └─────────────────────────────────────────────────────────┘
              ↓
    [
      { medicine: "برايمر", priority: "متأخر", days_until: -2 },
      { medicine: "كلون", priority: "متأخر", days_until: -1 },
      { medicine: "مضاد حيوي", priority: "اليوم", days_until: 0 },
      { medicine: "فيتامينات", priority: "غداً", days_until: 1 },
      ...
    ]
              ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  عرض في الواجهة:                                     ║
    ╠═══════════════════════════════════════════════════════╣
    ║                                                        ║
    ║  ┌───────────────────────────────────────────────┐   ║
    ║  │ 🚨 متأخر                                      │   ║
    ║  │ 💊 برايمر                                     │   ║
    ║  │ 📅 2025-10-08 (متأخر يومين)                  │   ║
    ║  │ [تم الإعطاء ✓]                               │   ║
    ║  └───────────────────────────────────────────────┘   ║
    ║                                                        ║
    ║  ┌───────────────────────────────────────────────┐   ║
    ║  │ ⚠️ اليوم                                      │   ║
    ║  │ 💊 مضاد حيوي                                 │   ║
    ║  │ 📅 2025-10-10 (اليوم)                        │   ║
    ║  │ [تم الإعطاء ✓]                               │   ║
    ║  └───────────────────────────────────────────────┘   ║
    ║                                                        ║
    ╚═══════════════════════════════════════════════════════╝


┌────────────────────────────────────────────────────────────────────────┐
│  المرحلة 5: المزارع يعطي الدواء ويحدد التنبيه                       │
└────────────────────────────────────────────────────────────────────────┘

    [المزارع يضغط "تم الإعطاء ✓"]
              ↓
    onClick={() => markAsAdministered(alert_id)}
              ↓
    markAlertAsAdministered(alert_id, notes)
              ↓
    supabase.rpc('mark_alert_as_administered', ...)
              ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  UPDATE medication_alerts                             ║
    ║  SET                                                  ║
    ║    is_administered = TRUE,                           ║
    ║    administered_at = NOW(),                          ║
    ║    notes = 'تم إعطاء الدواء...',                    ║
    ║    updated_at = NOW()                                ║
    ║  WHERE id = alert_id                                 ║
    ╚═══════════════════════════════════════════════════════╝
              ↓
    ┌─────────────────────────────────────────────────────────┐
    │  قبل:                                                   │
    │  ┌─────────────────────────────────────────────────┐   │
    │  │ id: uuid-123                                    │   │
    │  │ medicine_id: med-uuid                           │   │
    │  │ scheduled_date: 2025-10-10                      │   │
    │  │ is_administered: FALSE ❌                       │   │
    │  │ administered_at: NULL                           │   │
    │  │ notes: NULL                                     │   │
    │  └─────────────────────────────────────────────────┘   │
    │                       ↓                                 │
    │                   [تحديث]                              │
    │                       ↓                                 │
    │  بعد:                                                   │
    │  ┌─────────────────────────────────────────────────┐   │
    │  │ id: uuid-123                                    │   │
    │  │ medicine_id: med-uuid                           │   │
    │  │ scheduled_date: 2025-10-10                      │   │
    │  │ is_administered: TRUE ✅                        │   │
    │  │ administered_at: 2025-10-10 14:30:00           │   │
    │  │ notes: 'تم إعطاء الدواء في الموعد'            │   │
    │  └─────────────────────────────────────────────────┘   │
    └─────────────────────────────────────────────────────────┘
              ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  ✅ التنبيه لا يظهر في قائمة التنبيهات النشطة       ║
    ║  ✅ يظهر في السجل/التاريخ فقط                       ║
    ║  ✅ يتم تحديث الإحصائيات تلقائياً                   ║
    ╚═══════════════════════════════════════════════════════╝
              ↓
    revalidatePath('/farmer') → تحديث الصفحة


┌────────────────────────────────────────────────────────────────────────┐
│  المرحلة 6: الإحصائيات والتقارير                                     │
└────────────────────────────────────────────────────────────────────────┘

    getFarmAlertStats('farm-uuid')
              ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  إحصائيات المزرعة:                                   ║
    ╠═══════════════════════════════════════════════════════╣
    ║                                                        ║
    ║  📊 الإجمالي:        45 تنبيه                       ║
    ║  ✅ المكتملة:        12 تنبيه                       ║
    ║  ⏳ المعلقة:         33 تنبيه                       ║
    ║  🚨 المتأخرة:        3  تنبيه                       ║
    ║  ⚠️ اليوم:           2  تنبيه                       ║
    ║  📌 غداً:            1  تنبيه                       ║
    ║                                                        ║
    ║  📈 نسبة الإنجاز:    26.7%                          ║
    ║  🎯 نسبة الالتزام:   80%  (في الموعد)              ║
    ║                                                        ║
    ╚═══════════════════════════════════════════════════════╝

    v_medication_alerts_summary (للمدراء)
              ↓
    ╔═══════════════════════════════════════════════════════╗
    ║  ملخص جميع المزارع:                                  ║
    ╠═══════════════════════════════════════════════════════╣
    ║                                                        ║
    ║  ┌────────────┬──────┬────────┬────────┬────────┐    ║
    ║  │ المزرعة    │ عمر  │ الكل   │ المكتمل│ المتأخر│    ║
    ║  ├────────────┼──────┼────────┼────────┼────────┤    ║
    ║  │ الوادي     │ 15   │ 45    │ 12    │ 3     │    ║
    ║  │ النور      │ 30   │ 48    │ 25    │ 0     │    ║
    ║  │ السلام     │ 60   │ 50    │ 40    │ 1     │    ║
    ║  └────────────┴──────┴────────┴────────┴────────┘    ║
    ║                                                        ║
    ╚═══════════════════════════════════════════════════════╝
```

---

## 🔄 حالات خاصة

### الحالة 1: تغيير تاريخ الميلاد

```
[المزارع يغير التاريخ]
         ↓
UPDATE poultry_status
SET chick_birth_date = '2025-10-01'  -- التاريخ الجديد
         ↓
    ⚡ Trigger
         ↓
┌──────────────────────────┐
│ 1. حذف التنبيهات القديمة │
└──────────────────────────┘
         ↓
DELETE FROM medication_alerts
WHERE poultry_status_id = 'uuid'
         ↓
┌──────────────────────────┐
│ 2. إنشاء تنبيهات جديدة   │
└──────────────────────────┘
         ↓
create_medication_alerts_for_poultry()
         ↓
✅ تنبيهات جديدة بناءً على التاريخ الجديد
```

### الحالة 2: إلغاء تحديد التنبيه (خطأ)

```
[المزارع ضغط بالخطأ]
         ↓
unmarkAlertAsAdministered(alert_id)
         ↓
UPDATE medication_alerts
SET 
  is_administered = FALSE,
  administered_at = NULL
         ↓
✅ التنبيه يعود للقائمة النشطة
```

---

## 📊 خط الزمن (Timeline)

```
اليوم 0   اليوم 1   اليوم 2   اليوم 3        اليوم 10
   │         │         │         │              │
   ↓         ↓         ↓         ↓              ↓
 ميلاد    مضاد 1    مضاد 2    مضاد 3        جامبورو
الفراخ
   │         │         │         │              │
   ↓         │         │         │              │
إنشاء      │         │         │              │
التنبيهات  │         │         │              │
   │         │         │         │              │
   ↓         ↓         ↓         ↓              ↓
  🔔        🔔        🔔        🔔             🔔
تنبيه      تنبيه     تنبيه     تنبيه          تنبيه
قبل يوم    قبل يوم   قبل يوم   قبل يوم        قبل يوم
```

---

## 🎯 الأدوار والصلاحيات

```
┌─────────────────────────────────────────────────────────┐
│                        المدير (Admin)                   │
├─────────────────────────────────────────────────────────┤
│  ✅ إنشاء المزارع والمزارعين                           │
│  ✅ إضافة/تعديل الأدوية في جدول medicines             │
│  ✅ إضافة/تعديل تاريخ ميلاد الفراخ                     │
│  ✅ رؤية جميع التنبيهات لجميع المزارع                  │
│  ✅ رؤية الإحصائيات الشاملة                            │
│  ✅ حذف/تعديل أي تنبيه                                 │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                      المزارع (Farmer)                   │
├─────────────────────────────────────────────────────────┤
│  ✅ رؤية تنبيهاته فقط                                  │
│  ✅ تحديد التنبيه كـ "تم إعطاء الدواء"                │
│  ✅ إضافة ملاحظات على التنبيهات                        │
│  ✅ رؤية إحصائيات مزرعته                               │
│  ❌ لا يمكنه حذف التنبيهات                             │
│  ❌ لا يمكنه رؤية تنبيهات مزارع آخر                   │
└─────────────────────────────────────────────────────────┘
```

---

## 🔍 مثال عملي كامل

### اليوم 0: 2025-10-10 (ميلاد الفراخ)

```sql
-- المدير ينشئ القطيع
INSERT INTO poultry_status (
  farm_id, batch_name, opening_chicks, chick_birth_date
) VALUES (
  'farm-uuid', 'قطيع 2025-01', 5000, '2025-10-10'
);

-- تلقائياً: يتم إنشاء 45 تنبيه
```

### اليوم 1: 2025-10-11

```
التنبيهات النشطة:
┌───────────────────────────────────────────┐
│ 🚨 متأخر (0 تنبيه)                       │
│ ⚠️ اليوم (3 تنبيهات):                    │
│   - مضاد حيوي (اليوم 1)                  │
│   - فيتامين ه س (اليوم 1)               │
│   - انرو فلوكساسين (اليوم 1)            │
│ 📌 غداً (3 تنبيهات):                     │
│   - مضاد حيوي (اليوم 2)                  │
│   - فيتامين ه س (اليوم 2)               │
│   - انرو فلوكساسين (اليوم 2)            │
└───────────────────────────────────────────┘

المزارع يعطي الأدوية ويحدد التنبيهات
→ 3 تنبيهات مكتملة
```

### اليوم 2: 2025-10-12

```
التنبيهات النشطة:
┌───────────────────────────────────────────┐
│ 🚨 متأخر (0 تنبيه)                       │
│ ⚠️ اليوم (3 تنبيهات):                    │
│   - مضاد حيوي (اليوم 2)                  │
│   - فيتامين ه س (اليوم 2)               │
│   - انرو فلوكساسين (اليوم 2)            │
│ 📌 غداً (3 تنبيهات):                     │
│   - مضاد حيوي (اليوم 3)                  │
│   - فيتامين ه س (اليوم 3)               │
│   - انرو فلوكساسين (اليوم 3)            │
└───────────────────────────────────────────┘
```

### اليوم 5: 2025-10-15 (إذا نسي المزارع)

```
التنبيهات النشطة:
┌───────────────────────────────────────────┐
│ 🚨 متأخر (9 تنبيهات):                    │
│   - مضاد حيوي (اليوم 2) - متأخر 3 أيام  │
│   - فيتامين (اليوم 2) - متأخر 3 أيام    │
│   - مضاد حيوي (اليوم 3) - متأخر يومين    │
│   - فيتامين (اليوم 3) - متأخر يومين      │
│   - برايمر (اليوم 4) - متأخر يوم واحد    │
│   ...                                      │
│ ⚠️ اليوم (0 تنبيه)                       │
│ 📌 غداً (1 تنبيه)                        │
└───────────────────────────────────────────┘
```

---

## 🎨 الألوان والرموز

### الأولويات
```
🚨 متأخر      → أحمر (bg-red-50, border-red-500)
⚠️ اليوم      → برتقالي (bg-orange-50, border-orange-500)
📌 غداً       → أصفر (bg-yellow-50, border-yellow-500)
📅 قادم       → أزرق (bg-blue-50, border-blue-500)
```

### الحالات
```
❌ لم يتم     → is_administered = FALSE
✅ تم         → is_administered = TRUE
⏳ معلق       → pending
📊 مكتمل      → completed
```

---

**📖 للمزيد من التفاصيل**: راجع `WORKFLOW.md` للشرح النصي الكامل.
